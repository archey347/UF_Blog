function preparePostForm(form) {
	form.ufForm({
		validators: page.validators.postEdit,
		msgTarget: $("#blog-alert")
	}).on("submitSuccess.ufForm", function(event, data, textStatus, jqXHR) {
		window.location.reload();
	});
}
		
function bindPostButtons(el) {
	el.find('.js-edit-post').click(function() {
		$("body").ufModal({
			sourceUrl: site.uri.public + "/modals/blog/post/edit",
			ajaxParams: {
				slug: page.blog.slug,
				id: $(this).data('postId')
			},
			msgTarget: $("#alerts-page")
		});
		$('body').on('renderSuccess.ufModal', function (data) {	
			preparePostForm($("#edit-post"))
		});	
	});
	el.find('.js-delete-post').click(function() {
		$("body").ufModal({
			sourceUrl: site.uri.public + "/modals/blog/post/delete",
			ajaxParams: {
				slug: page.blog.slug,
				id: $(this).data('postId')
			},
			msgTarget: $("#alerts-page")
		});
		$('body').on('renderSuccess.ufModal', function (data) {	
			$("#post-delete").ufForm({
				msgTarget: $("#blog-alert")
			}).on("submitSuccess.ufForm", function(event, data, textStatus, jqXHR) {
				window.location.reload();
			});
		});	
	});	
}

function bindPostCreateButton() {
	$("#btn_create_post").click(function() {
		$('body').ufModal({
			// URL that serves the modal HTML
			sourceUrl: site.uri.public + '/modals/blog/post/create',
			ajaxParams : {
				"blog_slug" : page.blog.slug
			},
			// Target element to display any errors generated by the modal request
			msgTarget: $('#alerts-page')
		});
		
		$('body').on('renderSuccess.ufModal', function (data) {
			preparePostForm($("#create-post"));
		});
	});
}

$(document).ready(function() {		
	$("#postsTable").ufTable({
		dataUrl: site.uri.public + "/api/blogs/b/" + page.blog.slug + "/posts"
	});
	
	$("#postsTable").on("pagerComplete.ufTable", function () {
		bindPostButtons($(this));
	});

	bindPostCreateButton();
});
