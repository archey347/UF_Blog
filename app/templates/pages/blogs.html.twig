{% extends 'pages/abstract/dashboard.html.twig' %}

{# Overrides blocks in head of base template #}
{% block page_title %}Blog Managment{% endblock %}
{% block page_description %}{% endblock %}

{% block body_matter %}
	<div id="blogTable" class="box box-primary">
		<div class="box-header">
			<h3 class="box-title pull-left"><i class="fa fa-fw fa-user"></i>Blogs</h3>
			{% include "tables/table-tool-menu.html.twig" %}
		</div>
		<div class="box-body">
			{% include "tables/blog-admin.html.twig" with {
					"table" : {
						"id" : "table-blogs"
					}
				}
			%}
		</div>
		<div class="box-footer">
			{% if checkAccess('uri_blog_manager') %}
			<button id="btn_create_blog" type="button" class="btn btn-success js-member-create">
				<i class="fa fa-plus-square"></i>  Create Blog
			</button>
			{% endif %}
		</div>
	</div>
	
{% endblock %}
{% block scripts_page %}
    <script type="text/javascript">
		
		{% include "pages/partials/page.js.twig" %}
		
		function bindBlogButtons(el) {
			el.find('.js-blog-edit').click(function() {
				$("body").ufModal({
					sourceUrl: site.uri.public + "/modals/blog/edit",
					ajaxParams: {
						slug: $(this).data('slug')
					},
					msgTarget: $("#alerts-page")
				});
				$('body').on('renderSuccess.ufModal', function (data) {
					$('input').iCheck({
						checkboxClass: 'icheckbox_square',
						radioClass: 'iradio_minimal',
						increaseArea: '20%' // optional
					  });
					hasWritten = false;
					$('#blog_name').keyup(function () {
						if(!hasWritten) {
							$('#blog_slug').val($('#blog_name').val().toLowerCase().replace(" ", "_"));
							$('#read_permission').val("blog_r_" +	$('#blog_slug').val());
							$('#write_permission').val("blog_w_" +	$('#blog_slug').val());
						}
					});
					$('#blog_slug').keyup(function () {
						hasWritten = true;
						$('#read_permission').val("blog_r_" +	$('#blog_slug').val());
						$('#write_permission').val("blog_w_" +	$('#blog_slug').val());
					});
					
					
					if($('#read_permission').val() == "") {
						$('#read_permission').val("blog_r_" +	$('#blog_name').val());
					}
					if($('#write_permission').val() == "") {
						$('#write_permission').val("blog_w_" +	$('#blog_name').val());
					}
					
					if($('#public').iCheck('update')[0].checked) {
						document.getElementById('read_permission_container').style.display = 'none';	
					}
					
					$('#public').on('ifChecked', function () {
						document.getElementById('read_permission_container').style.display = 'none';
					});
					
					$('#public').on('ifUnchecked', function () {
						document.getElementById('read_permission_container').style.display = 'block';
					});
					
					$("#edit-blog").ufForm({
						validators: page.validators.editBlog,
						msgTarget: $("#blog-alert")
					}).on("submitSuccess.ufForm", function(event, data, textStatus, jqXHR) {
						window.location.reload();
					});
				});
			});
			
			el.find('.js-blog-delete').click(function() {
					
					$("body").ufModal({
						sourceUrl: site.uri.public + "/modals/blog/confirm-delete",
						ajaxParams: {
							slug: $(this).data('slug')
						},
						msgTarget: $("#alerts-page")
					});
					$('body').on('renderSuccess.ufModal', function (data) {
					$("#blog-delete").ufForm({
						msgTarget: $("#form-delete-blog-error")
					}).on("submitSuccess.ufForm", function(event, data, textStatus, jqXHR) {
						window.location.reload();
					});
				});
			});
			
		}
		
		$(document).ready(function() {
			
			$("#blogTable").ufTable({
				dataUrl: site.uri.public + "/api/blogs"
			});
			
			$("#blogTable").on("pagerComplete.ufTable", function () {
			    bindBlogButtons($(this));
			});
			
			
			$("#btn_create_blog").click(function() {
				$('body').ufModal({
					// URL that serves the modal HTML
					sourceUrl: site.uri.public + '/modals/blog/create',
					// Target element to display any errors generated by the modal request
					msgTarget: $('#alerts-page')
				});
				
				
				
				$('body').on('renderSuccess.ufModal', function (data) {
					$('input').iCheck({
						checkboxClass: 'icheckbox_square',
						radioClass: 'iradio_minimal',
						increaseArea: '20%' // optional
					  });
					hasWritten = false;
					$('#blog_name').keyup(function () {
						if(!hasWritten) {
							$('#blog_slug').val($('#blog_name').val().toLowerCase().replace(" ", "_"));
							$('#read_permission').val("blog_r_" +	$('#blog_slug').val());
							$('#write_permission').val("blog_w_" +	$('#blog_slug').val());
						}
					});
					$('#blog_slug').keyup(function () {
						hasWritten = true;
						$('#read_permission').val("blog_r_" +	$('#blog_slug').val());
						$('#write_permission').val("blog_w_" +	$('#blog_slug').val());
					});
					
					
					if($('#read_permission').val() == "") {
						$('#read_permission').val("blog_r_" +	$('#blog_name').val());
					}
					if($('#write_permission').val() == "") {
						$('#write_permission').val("blog_w_" +	$('#blog_name').val());
					}
					
					if($('#public').iCheck('update')[0].checked) {
						document.getElementById('read_permission_container').style.display = 'none';	
					}
					
					$('#public').on('ifChecked', function () {
						document.getElementById('read_permission_container').style.display = 'none';
					});
					
					$('#public').on('ifUnchecked', function () {
						document.getElementById('read_permission_container').style.display = 'block';
					});
					
					
					$("#create-blog").ufForm({
						validators: page.validators.createBlog,
						msgTarget: $("#blog-alert")
					}).on("submitSuccess.ufForm", function(event, data, textStatus, jqXHR) {
						window.location.reload();
					});
				});
			});
		});
	</script>

{% endblock %}
