function bindPostButtons(el) {
    el.find('.js-edit-post').click(function () {
        $("body").ufModal({
            sourceUrl: site.uri.public + "/modals/blog/post/edit",
            ajaxParams: {
                slug: page.blog.slug,
                id: $(this).data('postId')
            },
            msgTarget: $("#alerts-page")
        });
        $('body').on('renderSuccess.ufModal', function (data) {
            ClassicEditor
                .create(document.querySelector('.js-editor'))
                .catch(error => {
                    console.error(error);
                });

            $("#edit-post").ufForm({
                validators: page.validators.postEdit,
                msgTarget: $("#blog-alert")
            }).on("submitSuccess.ufForm", function (event, data, textStatus, jqXHR) {
                window.location.reload();
            });

            // Image upload code
            bindImageBtn();
        });
    });
    el.find('.js-delete-post').click(function () {
        $("body").ufModal({
            sourceUrl: site.uri.public + "/modals/blog/post/delete",
            ajaxParams: {
                slug: page.blog.slug,
                id: $(this).data('postId')
            },
            msgTarget: $("#alerts-page")
        });
        $('body').on('renderSuccess.ufModal', function (data) {
            $("#post-delete").ufForm({
                msgTarget: $("#blog-alert")
            }).on("submitSuccess.ufForm", function (event, data, textStatus, jqXHR) {
                window.location.reload();
            });
        });
    });
}

$(document).ready(function () {
    $("#postsTable").ufTable({
        dataUrl: site.uri.public + "/api/blogs/b/" + page.blog.slug + "/posts"
    });

    $("#postsTable").on("pagerComplete.ufTable", function () {
        bindPostButtons($(this));
    });

    $("#btn_create_post").click(function () {
        $('body').ufModal({
            // URL that serves the modal HTML
            sourceUrl: site.uri.public + '/modals/blog/post/create',
            ajaxParams: {
                "blog_slug": page.blog.slug
            },
            // Target element to display any errors generated by the modal request
            msgTarget: $('#alerts-page')
        });


        $('body').on('renderSuccess.ufModal', function (data) {
            ClassicEditor
                .create(document.querySelector('.js-editor'))
                .catch(error => {
                    console.error(error);
                });

            $("#create-post").ufForm({
                validators: page.validators.postCreate,
                msgTarget: $("#blog-alert")
            }).on("submitSuccess.ufForm", function (event, data, textStatus, jqXHR) {
                window.location.reload();
            });

            //	Image upload code
            bindImageBtn();
        });
    });
});

function clearEditor() {
    for (var i = tinymce.editors.length - 1; i > -1; i--) {
        var ed_id = tinymce.editors[i].id;
        tinyMCE.execCommand("mceRemoveEditor", true, ed_id);
    }
}

function bindImageBtn() {
    $(".post_image_upload").on("click", function () {

        $(this).attr('disabled', true);

        // Get the image file
        var files = $("#post_image").prop('files');

        if (files.length <= 0) {
            $("#blog-alert").ufAlerts().ufAlerts('push', 'danger', 'No file selected').ufAlerts('render');
            $(this).attr('disabled', false);
            return;
        }

        var fd = new FormData();
        fd.append('post_image', files[0]);
        fd.append('post_id', $(this).data('post_id'));

        let append_url = "/images/upload";

        // Upload image file
        $.ajax({
            url: site.uri.public + append_url,
            type: 'POST',
            data: fd,
            contentType: false,
            processData: false,
            success: function (result) {
                $(this).attr('hidden', true);

                let post_og_image = $("#post_og_image");

                let jsonResponse = JSON.parse(result);

                if (jsonResponse.image_url) {
                    post_og_image.val(jsonResponse.image_url);
                }

                post_og_image.attr('readonly', true);
            },
            error: function (jqXHR, textStatus, errorThrown) {
                $(this).attr('disabled', false);

                if (errorThrown !== 'Unauthorized') {
                    $("#blog-alert").ufAlerts().ufAlerts('push', 'danger', 'Error occured, check your connection or try to refresh the page!').ufAlerts('render');
                }
                $("#blog-alert").ufAlerts().ufAlerts('fetch').ufAlerts('render')
            }
        });
        // if success, get url
        // if failed, push alert message
    });
}